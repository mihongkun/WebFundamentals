<!DOCTYPE html>
<html devsite>

<head>
  <meta name="project_path" value="_project.yaml" />
  <meta name="book_path" value="_book.yaml" />
  <meta name="gtm_var" data-key="docType" data-value="reference">
  <title>Source: utils/build.js</title>
  <link href="jsdoc.css" rel="stylesheet">
</head>

<body>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: utils/build.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>/*
 Copyright 2016 Google Inc. All Rights Reserved.
 Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/

/* eslint-disable no-console, valid-jsdoc */

const babel &#x3D; require(&#x27;rollup-plugin-babel&#x27;);
const childProcess &#x3D; require(&#x27;child_process&#x27;);
const commonjs &#x3D; require(&#x27;rollup-plugin-commonjs&#x27;);
const fs &#x3D; require(&#x27;fs&#x27;);
const os &#x3D; require(&#x27;os&#x27;);
const path &#x3D; require(&#x27;path&#x27;);
const promisify &#x3D; require(&#x27;promisify-node&#x27;);
const replace &#x3D; require(&#x27;rollup-plugin-replace&#x27;);
const resolve &#x3D; require(&#x27;rollup-plugin-node-resolve&#x27;);
const rollup &#x3D; require(&#x27;rollup&#x27;).rollup;

const globPromise &#x3D; promisify(&#x27;glob&#x27;);

const LICENSE_HEADER &#x3D; fs.readFileSync(&#x27;templates/LICENSE-HEADER.txt&#x27;, &#x27;utf8&#x27;);

/**
 * Wrapper on top of childProcess.spawn() that returns a promise which rejects
 * when the child process has a non-zero exit code and resolves otherwise.
 *
 * @param {String} command The command to spawn.
 * @param {Array.&amp;lt;String&gt;} args The parameters to pass to the command.
 * @return {Promise} Settles once command completes. Resolves if the exit code
 *                    is 0, and rejects otherwise.
 */
function processPromiseWrapper(command, args) {
  return new Promise((resolve, reject) &#x3D;&gt; {
    const process &#x3D; childProcess.spawn(command, args, {stdio: &#x27;inherit&#x27;});
    process.on(&#x27;error&#x27;, reject);
    process.on(&#x27;close&#x27;, (code) &#x3D;&gt; {
      if (code &#x3D;&#x3D;&#x3D; 0) {
        resolve();
      } else {
        reject(&#x60;Error ${code} returned from ${command} ${args}&#x60;);
      }
    });
  });
}

/**
 * Wrapper that runs the local node_modules/.bin/lerna binary, returning a
 * promise when complete.
 *
 * @param args Arguments to pass to the local lerna binary.
 * @return {Promise}
 */
function lernaWrapper(...args) {
  const nodeCommand &#x3D; os.platform() &#x3D;&#x3D;&#x3D; &#x27;win32&#x27; ? &#x27;npm.cmd&#x27; : &#x27;npm&#x27;;
  return processPromiseWrapper(nodeCommand,
    [&#x27;run&#x27;, &#x27;local-lerna&#x27;, &#x27;--&#x27;].concat(args));
}

/**
 * Promise.all() rejects immediately as soon as the first Promise rejects.
 * This wrapper will run each Promise to resolution, and if one or more
 * rejected, reject at the end with a concatenated error message.
 *
 * @param {Array.&amp;lt;Promise&gt;} promises The promises to wait on.
 * @return {Promise.&amp;lt;*&gt;} Resolves with null if all the promises resolve.
 *                        Otherwise, rejects with a concatenated error.
 */
function taskPromiseWrapper(projects, task, args) {
  let rejected &#x3D; [];
  return projects.reduce((promiseChain, project) &#x3D;&gt; {
    return promiseChain.then(() &#x3D;&gt; {
      return task(path.join(__dirname, &#x27;..&#x27;, path.dirname(project)), args)
      .catch((error) &#x3D;&gt; {
        rejected.push(error);
      });
    });
  }, Promise.resolve())
  .then(() &#x3D;&gt; rejected.length ? Promise.reject(rejected.join(&#x27;\n&#x27;)) : null);
}

/**
 * Helper function that runs a task against all projects, or just one of them.
 * It will collect all the results and reject if any of the tasks rejects.
 *
 * @param {Function} task The function to run.
 * @param {String} projectOrStar Either the name of a project, or &#x27;*&#x27; for all.
 * @param {...Object} [args] Optional additional arguments to pass to task.
 * @return {Promise.&amp;lt;*&gt;} Resolves with null if all the promises resolve.
 *                        Otherwise, rejects with a concatenated error.
 */
function taskHarness(task, projectOrStar, ...args) {
  return globPromise(&#x60;packages/${projectOrStar}/package.json&#x60;)
    .then((projects) &#x3D;&gt; taskPromiseWrapper(projects, task));
}

/**
 * This method will bundle JS with Rollup and write it out to disk.
 *
 * @param {Object} options
 * @param {Object} options.rollupConfig The configuration for rollup().
 * @param {Object} options.writeConfig The configuration for bundle.write().
 * @return {Promise}
 */
function buildJSBundle(options) {
  return rollup(options.rollupConfig)
    .then((bundle) &#x3D;&gt; bundle.write(options.writeConfig));
}

/**
 * A helper to generate Rollup build configurations.
 *
 * One build config is generated for each format given in formatToPath.
 * Both minified and unminified build configs are generated.
 *
 * @param {Object} input
 * @param {Object.&amp;lt;String,String&gt;} input.formatToPath A mapping of each format
 * (&#x27;iife&#x27;, &#x27;es&#x27;, etc.) to the path to use for the output.
 * @param {String} input.baseDir The path of the project directory.
 * @param {String} input.moduleName The name of the module, for the iife output.
 * @param {boolean} [input.shouldBuildProd] Whether or not we should also build
 * a production bundle. Defaults to true.
 * @param {String} [input.entry] Used to override the default entry value of
 * &#x60;${baseDir}/src/index.js&#x60;.
 * @returns {Array.&amp;lt;Object&gt;}
 */
function generateBuildConfigs({formatToPath, baseDir, moduleName,
                               entry, shouldBuildProd&#x3D;true}) {
  const buildConfigs &#x3D; [];

  const basePlugins &#x3D; [
    resolve({
      jsnext: true,
      main: true,
      browser: true,
    }),
    commonjs(),
  ];

  const devReplacePlugin &#x3D; replace({
    &#x27;&#x60;BUILD_PROCESS_REPLACE::BUILD_TARGET&#x60;&#x27;: &#x27;&#x60;dev&#x60;&#x27;,
  });

  const prodReplacePlugin &#x3D; replace({
    &#x27;&#x60;BUILD_PROCESS_REPLACE::BUILD_TARGET&#x60;&#x27;: &#x27;&#x60;prod&#x60;&#x27;,
    &#x27;error-stack-parser&#x27;: &#x27;./error-stack-parser-no-op&#x27;,
  });

  const babelPlugin &#x3D; babel({
    presets: [[&#x27;babili&#x27;, {
      comments: false,
    }]],
  });

  for (let format of Object.keys(formatToPath)) {
    buildConfigs.push({
      rollupConfig: {
        entry: entry || path.join(baseDir, &#x27;src&#x27;, &#x27;index.js&#x27;),
        plugins: [devReplacePlugin, ...basePlugins],
      },
      writeConfig: {
        banner: LICENSE_HEADER,
        sourceMap: true,
        dest: path.join(baseDir,
          formatToPath[format].replace(&#x27;.prod.&#x27;, &#x27;.dev.&#x27;)),
        moduleName,
        format,
      },
    });

    if (shouldBuildProd) {
      buildConfigs.push({
        rollupConfig: {
          entry: entry || path.join(baseDir, &#x27;src&#x27;, &#x27;index.js&#x27;),
          plugins: [prodReplacePlugin, ...basePlugins, babelPlugin],
        },
        writeConfig: {
          banner: LICENSE_HEADER,
          sourceMap: true,
          dest: path.join(baseDir, formatToPath[format]),
          moduleName,
          format,
        },
      });
    }
  }

  return buildConfigs;
}

module.exports &#x3D; {
  buildJSBundle,
  generateBuildConfigs,
  globPromise,
  lernaWrapper,
  processPromiseWrapper,
  taskHarness,
};
</code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
</body>

</html>