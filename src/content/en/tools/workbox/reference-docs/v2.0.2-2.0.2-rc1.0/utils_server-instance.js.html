<!DOCTYPE html>
<html devsite>

<head>
  <meta name="project_path" value="_project.yaml" />
  <meta name="book_path" value="_book.yaml" />
  <meta name="gtm_var" data-key="docType" data-value="reference">
  <title>Source: utils/server-instance.js</title>
  <link href="jsdoc.css" rel="stylesheet">
</head>

<body>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: utils/server-instance.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>/*
 Copyright 2016 Google Inc. All Rights Reserved.
 Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */

/* eslint-disable require-jsdoc, no-console */

const cookieParser &#x3D; require(&#x27;cookie-parser&#x27;);
const express &#x3D; require(&#x27;express&#x27;);
const fs &#x3D; require(&#x27;fs&#x27;);
const glob &#x3D; require(&#x27;glob&#x27;);
const handlebars &#x3D; require(&#x27;handlebars&#x27;);
const path &#x3D; require(&#x27;path&#x27;);
const serveIndex &#x3D; require(&#x27;serve-index&#x27;);
const serveStatic &#x3D; require(&#x27;serve-static&#x27;);

class ServerInstance {
  constructor() {
    this._server &#x3D; null;
    this._sockets &#x3D; [];

    this._app &#x3D; express();
    this._app.use(cookieParser());

    this._counter &#x3D; 1;

    // Test iframe is used by sw-testing-helpers to scope service workers
    this._app.get(&#x27;/test/iframe/:random&#x27;, function(req, res) {
      res.sendFile(path.join(__dirname, &#x27;test-iframe.html&#x27;));
    });

    this._app.get(&#x27;/__echo/filename/:file&#x27;, function(req, res) {
      res.setHeader(&#x27;Cache-Control&#x27;, &#x27;max-age&#x3D;&#x27; + (24 * 60 * 60));
      res.send(req.params.file);
    });

    this._app.get(&#x27;/__echo/counter&#x27;, (req, res) &#x3D;&gt; {
      res.setHeader(&#x27;Cache-Control&#x27;, &#x27;no-cache&#x27;);
      res.type(&#x27;text&#x27;).send(JSON.stringify(this._counter++));
    });

    this._app.get(&#x27;/__echo/date/:file&#x27;, function(req, res) {
      res.setHeader(&#x27;Cache-Control&#x27;, &#x27;max-age&#x3D;&#x27; + (24 * 60 * 60));
      res.send(&#x60;${req.params.file}-${Date.now()}&#x60;);
    });

    this._app.all(&#x27;/__echo/cors-no-cache/:file&#x27;, function(req, res) {
      res.setHeader(&#x27;Access-Control-Allow-Methods&#x27;,
        &#x27;POST, GET, PUT, DELETE, OPTIONS&#x27;);
      res.setHeader(&#x27;Cache-Control&#x27;, &#x27;no-cache&#x27;);
      res.setHeader(&#x27;Access-Control-Allow-Origin&#x27;, &#x27;*&#x27;);
      res.send(&#x60;${req.params.file}-${Date.now()}&#x60;);
    });

    this._app.all(&#x27;/__echo/date-with-cors/:file&#x27;, function(req, res) {
      res.setHeader(&#x27;Access-Control-Allow-Methods&#x27;,
        &#x27;POST, GET, PUT, DELETE, OPTIONS&#x27;);
      res.setHeader(&#x27;Cache-Control&#x27;, &#x27;max-age&#x3D;&#x27; + (24 * 60 * 60));
      res.setHeader(&#x27;Access-Control-Allow-Origin&#x27;, &#x27;*&#x27;);
      res.send(&#x60;${req.params.file}-${Date.now()}&#x60;);
    });

    this._app.get(&#x27;/__test/404/&#x27;, function(req, res) {
      res.status(404).send(&#x27;404&#x27;);
    });

    this._app.get(&#x27;/__test/redirect/:statusCode/&#x27;, function(req, res) {
      const statusCode &#x3D; parseInt(req.params.statusCode, 10);
      res.redirect(
        statusCode,
        &#x60;/__echo/filename/${statusCode}&#x60;
      );
    });

    this._app.get(&#x27;/__test/cookie/:id&#x27;, function(req, res) {
      res.send(JSON.stringify(req.cookies));
    });

    function respondWithScriptMatchingPattern(pattern, res) {
      const repoRoot &#x3D; path.join(__dirname, &#x27;..&#x27;);
      const devScript &#x3D; glob.sync(pattern, {
        cwd: repoRoot,
        root: repoRoot,
      });

      if (devScript.length &#x3D;&#x3D;&#x3D; 0) {
        const errMsg &#x3D; &#x60;No built module found for pattern &#x27;${pattern}&#x27;.&#x60;;
        console.log(errMsg);
        res.status(500).send(errMsg);
        return;
      }

      // We can&#x27;t send a redirect here, as they&#x27;re not allowed for resources
      // pulled in via importScripts().
      res.setHeader(&#x27;Content-Type&#x27;, &#x27;application/javascript&#x27;);
      res.send(fs.readFileSync(devScript[0]));
    }

    // Used to return the latest iife bundle for a given package, without
    // having to specify the version string.
    // This is used within unit tests.
    this._app.get(&#x27;/__test/bundle/:pkg&#x27;, function(req, res) {
      // By default, the prod bundles of our library code is used, with the
      // primary consumer being our test suite. This can be overridden by
      // setting a TEST_BUNDLE environment variable to &#x27;dev&#x27; prior to
      // starting the test suite.
      const build &#x3D; process.env.WB_TEST_BUNDLE || &#x27;prod&#x27;;
      const pkg &#x3D; req.params.pkg;
      const pattern &#x3D; &#x60;packages/${pkg}/build/importScripts/*${build}*.js&#x60;;
      respondWithScriptMatchingPattern(pattern, res);
    });

    // Harness to kick off all the in-browser tests for a given package.
    // It will pick up a list of all the top-level .js files and automatically
    // inject them into the HTML as &amp;lt;script&gt; tags.
    this._app.get(&#x27;/__test/mocha/browser/:pkg&#x27;, function(req, res) {
      const pkg &#x3D; req.params.pkg;

      let config &#x3D; {};
      try {
        // Read JSON file to avoid the require cache
        config &#x3D;
          JSON.parse(
            fs.readFileSync(
              path.join(__dirname, &#x27;..&#x27;, &#x27;packages&#x27;, pkg, &#x27;test&#x27;, &#x27;config.json&#x27;)
            , &#x27;utf-8&#x27;)
          );
      } catch (err) {
        // NOOP
      }

      const source &#x3D; fs.readFileSync(path.join(
        __dirname, &#x27;..&#x27;, &#x27;templates&#x27;, &#x27;test-browser.hbs&#x27;), &#x27;utf-8&#x27;);

      const template &#x3D; handlebars.compile(source);
      const html &#x3D; template({
        config,
        pkg,
      });

      res.send(html);
    });

    this._app.get(&#x27;/__test/mocha/sw/:pkg&#x27;, function(req, res) {
      const pkg &#x3D; req.params.pkg;
      const source &#x3D; fs.readFileSync(path.join(
        __dirname, &#x27;..&#x27;, &#x27;templates&#x27;, &#x27;test-sw.hbs&#x27;), &#x27;utf-8&#x27;);
      const template &#x3D; handlebars.compile(source);
      const html &#x3D; template({pkg});

      res.send(html);
    });

    this._app.get(&#x27;/__test/mocha/sw-utils.js&#x27;, function(req, res) {
      const source &#x3D; fs.readFileSync(path.join(
        __dirname, &#x27;sw-test-utils.js&#x27;), &#x27;utf-8&#x27;);

        res.send(source);
    });

    // Redirect /packages/:pkg/test/browser/ to the /__test/mocha/browser/:pkg
    // templated page, but only if there&#x27;s no
    // /packages/:pkg/test/browser/index.html
    this._app.get(&#x27;/packages/:pkg/test/browser/&#x27;, function(req, res, next) {
      const index &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;packages&#x27;, req.params.pkg,
        &#x27;test&#x27;, &#x27;browser&#x27;, &#x27;index.html&#x27;);
      if (fs.existsSync(index)) {
        next();
      } else {
        res.redirect(301, &#x60;/__test/mocha/browser/${req.params.pkg}&#x60;);
      }
    });

    this._app.get(&#x27;/packages/:pkg/test/sw/&#x27;, function(req, res, next) {
      const index &#x3D; path.join(__dirname, &#x27;..&#x27;, &#x27;packages&#x27;, req.params.pkg,
        &#x27;test&#x27;, &#x27;browser&#x27;, &#x27;index.html&#x27;);
      if (fs.existsSync(index)) {
        next();
      } else {
        res.redirect(301, &#x60;/__test/mocha/sw/${req.params.pkg}&#x60;);
      }
    });
  }

  start(rootDirectory, port) {
    if (typeof port &#x3D;&#x3D;&#x3D; &#x27;undefined&#x27;) {
      port &#x3D; 0;
    }

    if (this._server) {
      return Promise.reject(new Error(&#x27;Server already started.&#x27;));
    }

    this._app.use(&#x27;/&#x27;, express.static(rootDirectory, {
      setHeaders: (res) &#x3D;&gt; {
        res.append(&#x27;Set-Cookie&#x27;, &#x60;swtesting&#x3D;${Date.now()}; Path&#x3D;/;&#x60;);
        res.setHeader(&#x27;Service-Worker-Allowed&#x27;, &#x27;/&#x27;);
      },
    }));

    this._app.use(serveStatic(rootDirectory));
    this._app.use(serveIndex(rootDirectory, {view: &#x27;details&#x27;}));

    return new Promise((resolve, reject) &#x3D;&gt; {
      this._server &#x3D; this._app.listen(port, &#x27;localhost&#x27;, () &#x3D;&gt; {
        if (process.env.TRAVIS) {
          console.log(&#x60;[Debug Info] Test Server: &#x60; +
            &#x60;http://localhost:${this._server.address().port}&#x60;);
          console.log(&#x27;&#x27;);
        }
        resolve(this._server.address().port);
      });

      this._server.on(&#x27;connection&#x27;, (socket) &#x3D;&gt; {
        this._sockets.push(socket);
      });
    });
  }

  stop() {
    return new Promise((resolve) &#x3D;&gt; {
      this._sockets.forEach((socket) &#x3D;&gt; {
        socket.destroy();
      });

      this._server.close(resolve);
      this._server &#x3D; null;
    });
  }
}

module.exports &#x3D; ServerInstance;
</code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
</body>

</html>